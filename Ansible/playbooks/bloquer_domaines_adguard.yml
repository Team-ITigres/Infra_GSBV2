- name: Bloquer des domaines dans AdGuard Home
  hosts: Adguard
  gather_facts: yes

  vars_files:
    - ../vars/generated_vars.yml

  tasks:
    - name: Verifier que la liste des domaines est definie
      ansible.builtin.assert:
        that:
          - domains is defined
          - domains | length > 0
        fail_msg: "Erreur : la variable domains est absente ou vide"

    - name: Afficher les domaines a bloquer
      ansible.builtin.debug:
        msg: |
          Ajout de {{ domains | length }} domaine(s) a la liste de blocage :
          {{ domains | join(', ') }}

    - name: Verifier si le fichier de configuration existe
      ansible.builtin.stat:
        path: /opt/AdGuardHome/AdGuardHome.yaml
      register: config_file

    - name: Echouer si le fichier de configuration n'existe pas
      ansible.builtin.fail:
        msg: "Le fichier de configuration AdGuard n'existe pas"
      when: not config_file.stat.exists

    - name: Creer une sauvegarde de la configuration actuelle
      ansible.builtin.copy:
        src: /opt/AdGuardHome/AdGuardHome.yaml
        dest: "/opt/AdGuardHome/AdGuardHome.yaml.backup.{{ ansible_date_time.epoch }}"
        remote_src: yes
        mode: '0600'

    - name: Ajouter les domaines a la section blocked_hosts
      ansible.builtin.lineinfile:
        path: /opt/AdGuardHome/AdGuardHome.yaml
        insertafter: '^  blocked_hosts:'
        line: "    - {{ item }}"
        state: present
      loop: "{{ domains }}"
      register: domains_added

    - name: Redemarrer AdGuard Home si necessaire
      ansible.builtin.systemd:
        name: AdGuardHome
        state: restarted
      when: domains_added is changed

    - name: Attendre le redemarrage d'AdGuard
      ansible.builtin.wait_for:
        port: 53
        delay: 2
        timeout: 30
      when: domains_added is changed

    - name: Resume
      ansible.builtin.debug:
        msg: |
          ================================================================
          Blocage de domaines AdGuard termine
          ================================================================

          Domaines bloques :
          {% for d in domains %}
          - {{ d }}
          {% endfor %}
