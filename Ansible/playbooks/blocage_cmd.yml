---
- name: Creer une GPO pour bloquer l'acces au CMD
  hosts: WinSRV01
  gather_facts: no

  tasks:
    - name: Verifier que les variables sont definies
      ansible.builtin.assert:
        that:
          - ou_name is defined
          - group_name is defined
          - block_cmd is defined
        fail_msg: "Erreur : Les variables ou_name, group_name et block_cmd doivent etre definies"
      when: block_cmd is defined and block_cmd == "oui"

    - name: Construire les variables
      ansible.builtin.set_fact:
        gpo_name: "Block_CMD_{{ group_name }}"
        ou_path: "OU={{ ou_name }},DC=gsb,DC=local"
      when: block_cmd is defined and block_cmd == "oui"

    - name: Afficher les informations de la GPO
      ansible.builtin.debug:
        msg: |
          Creation de la GPO de blocage CMD :
          - Nom : {{ gpo_name }}
          - OU cible : {{ ou_name }}
          - Groupe cible : {{ group_name }}
      when: block_cmd is defined and block_cmd == "oui"

    - name: Creer la GPO pour bloquer le CMD
      ansible.windows.win_shell: |
        Import-Module GroupPolicy

        $gpoName = "{{ gpo_name }}"
        $gpoExists = Get-GPO -Name $gpoName -ErrorAction SilentlyContinue

        if (-not $gpoExists) {
            $gpo = New-GPO -Name $gpoName -Comment "Blocage de l'acces au CMD pour le groupe {{ group_name }}"
            Write-Output "GPO_CREATED"
        } else {
            $gpo = $gpoExists
            Write-Output "GPO_EXISTS"
        }

        $gpo.Id.Guid
      register: gpo_creation
      when: block_cmd is defined and block_cmd == "oui"

    - name: Extraire le GUID
      ansible.builtin.set_fact:
        gpo_guid: "{{ gpo_creation.stdout_lines[-1] }}"
      when: block_cmd is defined and block_cmd == "oui"

    - name: Configurer la valeur de registre pour bloquer le CMD
      ansible.windows.win_shell: |
        Import-Module GroupPolicy
        Set-GPRegistryValue -Name "{{ gpo_name }}" -Key "HKCU\Software\Policies\Microsoft\Windows\System" -ValueName "DisableCMD" -Type DWord -Value 2
        Write-Output "REGISTRY_CONFIGURED"
      when: block_cmd is defined and block_cmd == "oui"

    - name: Lier la GPO a l'OU
      ansible.windows.win_shell: |
        Import-Module GroupPolicy
        $ouPath = "{{ ou_path }}"
        $gpoName = "{{ gpo_name }}"

        $existingLinks = Get-GPInheritance -Target $ouPath |
          Select-Object -ExpandProperty GpoLinks |
          Where-Object { $_.DisplayName -eq $gpoName }

        if (-not $existingLinks) {
            New-GPLink -Name $gpoName -Target $ouPath -LinkEnabled Yes | Out-Null
            Write-Output "LINK_CREATED"
        } else {
            Write-Output "LINK_EXISTS"
        }
      when: block_cmd is defined and block_cmd == "oui"

    - name: Configurer le filtrage de securite
      ansible.windows.win_shell: |
        Import-Module GroupPolicy
        $gpoName = "{{ gpo_name }}"
        $groupName = "{{ group_name }}"

        try {
            Set-GPPermission -Name $gpoName -TargetName 'Authenticated Users' -TargetType Group -PermissionLevel None -Replace -ErrorAction SilentlyContinue
        } catch {}

        Set-GPPermission -Name $gpoName -TargetName $groupName -TargetType Group -PermissionLevel GpoApply
        Write-Output "SECURITY_FILTERING_CONFIGURED"
      when: block_cmd is defined and block_cmd == "oui"
