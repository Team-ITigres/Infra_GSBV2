---
- name: Configuration VLAN sur Sw02
  hosts: Sw02
  gather_facts: no

  vars:
    ansible_ssh_common_args: '-o ControlMaster=no'

  tasks:
    - name: Verifier que les variables sont definies
      ansible.builtin.assert:
        that:
          - vlan_id is defined
          - vlan_name is defined
        fail_msg: "Erreur : Les variables vlan_id et vlan_name doivent etre definies"

    - name: Parser les ports access et trunk
      ansible.builtin.set_fact:
        access_ports: "{{ (access_ports | from_json) if access_ports is string else (access_ports | default([])) }}"
        trunk_ports: "{{ (trunk_ports | from_json) if trunk_ports is string else (trunk_ports | default([])) }}"

    - name: Afficher les informations du VLAN
      ansible.builtin.debug:
        msg: |
          Configuration du VLAN sur Sw02
          - VLAN ID   : {{ vlan_id }}
          - VLAN Name : {{ vlan_name }}
          - Ports Access : {{ access_ports }}
          - Ports Trunk  : {{ trunk_ports }}

    - name: Creer le VLAN sur Sw02
      ansible.builtin.shell: |
        expect << 'EOF'
        set timeout 30
        log_user 1
        spawn ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ControlMaster=no {{ ansible_user }}@{{ ansible_host }}
        expect {
          "Press <Enter> to continue..." { send "\r" }
          "Username:" { send "{{ ansible_user }}\r" }
          timeout { exit 1 }
        }
        expect {
          "Username:" { send "{{ ansible_user }}\r" }
          "Password:" { send "{{ ansible_password }}\r" }
          timeout { exit 1 }
        }
        expect {
          "Password:" { send "{{ ansible_password }}\r" }
          "#" { }
          timeout { exit 1 }
        }
        expect "#"
        send "configure\r"
        sleep 1
        send "vlan {{ vlan_id }}\r"
        sleep 1
        send "name {{ vlan_name }}\r"
        sleep 1
        send "exit\r"
        sleep 1
        send "exit\r"
        sleep 1
        send "exit\r"
        expect eof
        EOF
      delegate_to: localhost
      register: vlan_creation
      changed_when: true

    - name: Attendre stabilisation
      ansible.builtin.pause:
        seconds: 2

    - name: Configurer les ports en mode access
      ansible.builtin.shell: |
        expect << 'EOF'
        set timeout 60
        log_user 1
        spawn ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ControlMaster=no {{ ansible_user }}@{{ ansible_host }}
        expect {
          "Press <Enter> to continue..." { send "\r" }
          "Username:" { send "{{ ansible_user }}\r" }
          timeout { exit 1 }
        }
        expect {
          "Username:" { send "{{ ansible_user }}\r" }
          "Password:" { send "{{ ansible_password }}\r" }
          timeout { exit 1 }
        }
        expect {
          "Password:" { send "{{ ansible_password }}\r" }
          "#" { }
          timeout { exit 1 }
        }
        expect "#"
        send "configure\r"
        sleep 1
        {% for port in access_ports %}
        send "interface {{ port }}\r"
        sleep 1
        send "switchport mode access\r"
        sleep 1
        send "switchport access vlan {{ vlan_id }}\r"
        sleep 1
        send "exit\r"
        sleep 1
        {% endfor %}
        send "exit\r"
        sleep 1
        send "exit\r"
        expect eof
        EOF
      delegate_to: localhost
      when: access_ports | length > 0
      register: access_config

    - name: Attendre stabilisation
      ansible.builtin.pause:
        seconds: 2
      when: access_ports | length > 0

    - name: Configurer les ports en mode trunk
      ansible.builtin.shell: |
        expect << 'EOF'
        set timeout 60
        log_user 1
        spawn ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ControlMaster=no {{ ansible_user }}@{{ ansible_host }}
        expect {
          "Press <Enter> to continue..." { send "\r" }
          "Username:" { send "{{ ansible_user }}\r" }
          timeout { exit 1 }
        }
        expect {
          "Username:" { send "{{ ansible_user }}\r" }
          "Password:" { send "{{ ansible_password }}\r" }
          timeout { exit 1 }
        }
        expect {
          "Password:" { send "{{ ansible_password }}\r" }
          "#" { }
          timeout { exit 1 }
        }
        expect "#"
        send "configure\r"
        sleep 1
        {% for port in trunk_ports %}
        send "interface {{ port }}\r"
        sleep 1
        send "switchport mode trunk\r"
        sleep 1
        send "switchport trunk allowed vlan add {{ vlan_id }}\r"
        sleep 1
        send "exit\r"
        sleep 1
        {% endfor %}
        send "exit\r"
        sleep 1
        send "exit\r"
        expect eof
        EOF
      delegate_to: localhost
      when: trunk_ports | length > 0
      register: trunk_config

    - name: Afficher le resume
      ansible.builtin.debug:
        msg: |
          ================================================================
          Configuration VLAN terminee sur Sw02
          ================================================================

          VLAN {{ vlan_id }} ({{ vlan_name }}) cree avec succes

          Ports configures en mode Access (VLAN {{ vlan_id }}) :
          {% if access_ports | length > 0 %}
          {% for port in access_ports %}
          - {{ port }}
          {% endfor %}
          {% else %}
          - Aucun
          {% endif %}

          Ports configures en mode Trunk (VLAN {{ vlan_id }} ajoute) :
          {% if trunk_ports | length > 0 %}
          {% for port in trunk_ports %}
          - {{ port }}
          {% endfor %}
          {% else %}
          - Aucun
          {% endif %}
