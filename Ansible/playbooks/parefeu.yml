---
- name: Gestion des regles de pare-feu EdgeRouter
  hosts: routeur
  gather_facts: no

  vars_files:
    - ../vars/generated_vars.yml

  vars:
    service_ports:
      http: 80
      https: 443
      ssh: 22
      rdp: 3389
      dns: 53
      smtp: 25
      smb: 445
      mysql: 3306
      postgresql: 5432
      dhcp: 67
      ntp: 123
      snmp: 161
      icmp: icmp
      ping: icmp
      all: all

  tasks:
    - name: Verifier si une règle de pare-feu doit être créée
      ansible.builtin.debug:
        msg: "Aucune règle de pare-feu à créer (firewall_rule = {{ firewall_rule | default('non') }})"
      when: firewall_rule is not defined or firewall_rule != "oui"

    - name: Configuration du pare-feu
      block:
        - name: Verifier que les variables sont definies
          ansible.builtin.assert:
            that:
              - vlan_source is defined
              - vlan_dest is defined
              - service is defined
              - description is defined
            fail_msg: "Erreur : Les variables vlan_source, vlan_dest, service et description doivent etre definies"

        - name: Convertir vlan_dest en liste
          ansible.builtin.set_fact:
            dest_vlans: "{{ vlan_dest.split(',') if ',' in vlan_dest else [vlan_dest] }}"

        - name: Afficher les VLANs de destination
          ansible.builtin.debug:
            msg: |
              VLAN source : {{ vlan_source }}
              VLANs de destination : {{ dest_vlans | join(', ') }}

        - name: Attacher la VIF source au ruleset INTERVLAN_POLICY
          vyos.vyos.vyos_command:
            commands:
              - configure
              - set interfaces ethernet eth1 vif {{ vlan_source }} firewall in name INTERVLAN_POLICY
              - commit
              - save
              - exit
          register: vif_source_attachment

        - name: Attacher toutes les VIF de destination au ruleset INTERVLAN_POLICY
          vyos.vyos.vyos_command:
            commands:
              - configure
              - set interfaces ethernet eth1 vif {{ item }} firewall in name INTERVLAN_POLICY
              - commit
              - save
              - exit
          loop: "{{ dest_vlans }}"
          register: vif_dest_attachment

        - name: Afficher le resultat de l'attachement des VIF
          ansible.builtin.debug:
            msg: "VIF {{ vlan_source }} et VIF {{ dest_vlans | join(', ') }} attachees au ruleset INTERVLAN_POLICY"

        - name: Determiner le port du service et le protocole
          ansible.builtin.set_fact:
            port_number: "{{ service_ports[service] | default(service) }}"
            protocol: "{{ 'icmp' if (service_ports[service] | default(service)) == 'icmp' else ('all' if (service_ports[service] | default(service)) == 'all' else 'tcp_udp') }}"

        - name: Construire le nom de l'interface source
          ansible.builtin.set_fact:
            source_interface: "eth1.{{ vlan_source }}"

        - name: Recuperer le dernier numero de regle
          vyos.vyos.vyos_command:
            commands:
              - show firewall name INTERVLAN_POLICY
          register: ruleset_output

        - name: Extraire le dernier numero de regle
          ansible.builtin.set_fact:
            last_rule_num: "{{ ruleset_output.stdout[0] | regex_findall('rule (\\d+)') | map('int') | max | default(0) }}"

        - name: Creer les regles pour chaque VLAN de destination
          include_tasks: parefeu_create_rule.yml
          loop: "{{ dest_vlans }}"
          loop_control:
            loop_var: current_dest_vlan
            index_var: vlan_index

        - name: Afficher le resume
          ansible.builtin.debug:
            msg: |
              ================================================================
              Regles de pare-feu creees avec succes
              ================================================================

              Ruleset : INTERVLAN_POLICY
              Source : VLAN {{ vlan_source }} ({{ source_interface }})
              Destinations : {{ dest_vlans | join(', ') }}
              Service bloque : {{ service }} ({{ protocol }})
              Description : {{ description }}

              Nombre de regles creees : {{ dest_vlans | length }}

      when: firewall_rule is defined and firewall_rule == "oui"
