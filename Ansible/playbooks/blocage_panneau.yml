---
- name: Creer une GPO pour bloquer l'acces au Panneau de configuration
  hosts: WinSRV01
  gather_facts: no

  tasks:
    - name: Verifier que les variables sont definies
      ansible.builtin.assert:
        that:
          - ou_name is defined
          - ad_group is defined
        fail_msg: "Erreur : Les variables ou_name et ad_group doivent etre definies"

    - name: Construire les variables
      ansible.builtin.set_fact:
        gpo_name: "Block_ControlPanel_{{ ad_group }}"
        ou_path: "OU={{ ou_name }},DC=gsb,DC=local"

    - name: Afficher les informations de la GPO
      ansible.builtin.debug:
        msg: |
          Creation de la GPO de blocage Panneau de configuration :
          - Nom : {{ gpo_name }}
          - OU cible : {{ ou_name }}
          - Groupe cible : {{ ad_group }}

    - name: Creer la GPO pour bloquer le Panneau de configuration
      ansible.windows.win_shell: |
        Import-Module GroupPolicy

        $gpoName = "{{ gpo_name }}"
        $gpoExists = Get-GPO -Name $gpoName -ErrorAction SilentlyContinue

        if (-not $gpoExists) {
            $gpo = New-GPO -Name $gpoName -Comment "Blocage de l'acces au Panneau de configuration pour le groupe {{ ad_group }}"
            Write-Output "GPO_CREATED"
        } else {
            $gpo = $gpoExists
            Write-Output "GPO_EXISTS"
        }

        $gpo.Id.Guid
      register: gpo_creation

    - name: Extraire le GUID
      ansible.builtin.set_fact:
        gpo_guid: "{{ gpo_creation.stdout_lines[-1] }}"

    - name: Configurer la valeur de registre pour bloquer le Panneau de configuration
      ansible.windows.win_shell: |
        Import-Module GroupPolicy
        Set-GPRegistryValue -Name "{{ gpo_name }}" -Key "HKCU\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer" -ValueName "NoControlPanel" -Type DWord -Value 1
        Write-Output "REGISTRY_CONFIGURED"
      register: registry_config

    - name: Lier la GPO a l'OU
      ansible.windows.win_shell: |
        Import-Module GroupPolicy
        $ouPath = "{{ ou_path }}"
        $gpoName = "{{ gpo_name }}"

        $existingLinks = Get-GPInheritance -Target $ouPath | Select-Object -ExpandProperty GpoLinks | Where-Object { $_.DisplayName -eq $gpoName }

        if (-not $existingLinks) {
            New-GPLink -Name $gpoName -Target $ouPath -LinkEnabled Yes | Out-Null
            Write-Output "LINK_CREATED"
        } else {
            Write-Output "LINK_EXISTS"
        }
      register: gpo_link

    - name: Configurer le filtrage de securite
      ansible.windows.win_shell: |
        Import-Module GroupPolicy
        $gpoName = "{{ gpo_name }}"
        $groupName = "{{ ad_group }}"

        try {
            Set-GPPermission -Name $gpoName -TargetName 'Authenticated Users' -TargetType Group -PermissionLevel None -Replace -ErrorAction SilentlyContinue
        } catch {}

        Set-GPPermission -Name $gpoName -TargetName $groupName -TargetType Group -PermissionLevel GpoApply
        Write-Output "SECURITY_FILTERING_CONFIGURED"
      register: security_filtering

    - name: Afficher le resume
      ansible.builtin.debug:
        msg: |
          ================================================================
          GPO de blocage Panneau de configuration creee avec succes
          ================================================================

          GPO : {{ gpo_name }}
          GUID : {{ gpo_guid }}
          OU cible : {{ ou_name }}
          Groupe cible : {{ ad_group }}

          Configuration :
          - Blocage du Panneau de configuration active
          - Securite filtree sur le groupe {{ ad_group }}
          - GPO liee a {{ ou_path }}

          IMPORTANT :
          - Les utilisateurs du groupe {{ ad_group }} devront se deconnecter/reconnecter
          - Pour appliquer immediatement : gpupdate /force sur les postes clients
          - Le Panneau de configuration et les Parametres Windows seront bloques
