- name: Créer le dossier Pulse
  ansible.builtin.file:
    path: /srv/pulse
    state: directory
    mode: '0755'

- name: Déployer le docker-compose.yml pour Pulse
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: /srv/pulse/docker-compose.yml
    mode: '0644'
  register: pulse_docker_compose_deployed

- name: Lancer le conteneur Pulse
  community.docker.docker_compose_v2:
    project_src: /srv/pulse
    state: present
    recreate: "{{ 'always' if pulse_docker_compose_deployed.changed else 'never' }}"

- name: Attendre que Pulse soit complètement démarré
  ansible.builtin.uri:
    url: "http://localhost:{{ pulse_frontend_port | default('7655') }}/health"
    status_code: 200
    timeout: 5
  register: pulse_health_check
  until: pulse_health_check.status == 200
  retries: 12
  delay: 5
  ignore_errors: true

- name: Créer un token API pour les agents d'infrastructure
  ansible.builtin.uri:
    url: "http://{{ ansible_host }}:{{ pulse_frontend_port }}/api/security/tokens"
    method: POST
    user: "{{ pulse_auth_user }}"
    password: "{{ pulse_auth_pass }}"
    force_basic_auth: yes
    body_format: json
    body:
      name: "{{ pulse_agent_token_name }}"
      scopes: ["docker:report", "monitoring:read", "monitoring:write"]
    status_code: [200, 201]
    timeout: 10
  register: pulse_agent_token_response
  until: pulse_agent_token_response.status in [200, 201]
  retries: 3
  delay: 5
  when: pulse_create_agent_token | default(true)
  ignore_errors: true

- name: Debug - Afficher la réponse de création du token
  ansible.builtin.debug:
    msg: |
      Statut de la création du token:
      - Réponse définie: {{ pulse_agent_token_response is defined }}
      - Statut HTTP: {{ pulse_agent_token_response.status | default('N/A') }}
      - JSON présent: {{ pulse_agent_token_response.json is defined | default(false) }}
      - Token présent: {{ pulse_agent_token_response.json.token is defined | default(false) if pulse_agent_token_response.json is defined else false }}
  when: pulse_create_agent_token | default(true)

- name: Stocker le token comme fact Ansible (accessible via hostvars)
  ansible.builtin.set_fact:
    pulse_agent_token: "{{ pulse_agent_token_response.json.token }}"
    cacheable: yes
  when:
    - pulse_create_agent_token | default(true)
    - pulse_agent_token_response is defined
    - pulse_agent_token_response.json is defined
    - pulse_agent_token_response.json.token is defined

- name: Avertissement si le token n'a pas pu être créé
  ansible.builtin.debug:
    msg: |
      ATTENTION: Le token Pulse n'a pas pu être créé !
      Les agents Pulse ne pourront pas être déployés sur les autres machines.
      Vérifiez que l'API Pulse est accessible et fonctionne correctement.
  when:
    - pulse_create_agent_token | default(true)
    - pulse_agent_token is not defined or pulse_agent_token == ""

- name: Configurer le node Proxmox dans Pulse avec le token
  ansible.builtin.uri:
    url: "http://{{ ansible_host }}:{{ pulse_frontend_port }}/api/config/nodes"
    method: POST
    user: "{{ pulse_auth_user }}"
    password: "{{ pulse_auth_pass }}"
    force_basic_auth: yes
    body_format: json
    body:
      type: "pve"
      name: "{{ lookup('env', 'PULSE_PROXMOX_NODE') | default(inventory_hostname) }}"
      host: "{{ lookup('env', 'PULSE_PROXMOX_URL') }}"
      tokenName: "{{ lookup('env', 'PULSE_PROXMOX_TOKEN_ID') }}"
      tokenValue: "{{ lookup('env', 'PULSE_PROXMOX_TOKEN') }}"
      verifySSL: false
    status_code: [200, 201, 409]
  when:
    - lookup('env', 'PULSE_PROXMOX_TOKEN_ID') | default('') != ''
    - lookup('env', 'PULSE_PROXMOX_TOKEN') | default('') != ''
  register: pulse_node_config
  ignore_errors: true

- name: Afficher le résultat de la configuration du node
  ansible.builtin.debug:
    msg: "Node Proxmox configuré dans Pulse: {{ pulse_node_config.json | default('Erreur ou déjà configuré') }}"
  when: pulse_node_config is defined

- name: Afficher l'URL d'accès à Pulse
  ansible.builtin.debug:
    msg:
      - "Pulse est déployé avec succès !"
      - "URL d'accès: http://{{ ansible_host }}:{{ pulse_frontend_port | default('7655') }}"
      - "Utilisateur: {{ pulse_auth_user }}"
      - "Note: Changez le mot de passe par défaut après la première connexion"
      - "{% if pulse_agent_token is defined %}Token pour agents: {{ pulse_agent_token }}{% endif %}"
      - "{% if pulse_node_config.status is defined and pulse_node_config.status in [200, 201] %}Node Proxmox configuré automatiquement via token API{% endif %}"
