---
# Configuration LDAP automatique pour GLPI
# Ce fichier configure l'authentification LDAP/Active Directory dans GLPI

- name: Attendre que GLPI soit complètement démarré
  ansible.builtin.wait_for:
    timeout: 10
  delegate_to: localhost

- name: Supprimer l'ancienne configuration LDAP si elle existe
  community.docker.docker_container_exec:
    container: glpi_db
    command: mariadb -u {{ glpi_mysql_user }} -p{{ glpi_mysql_password }} {{ glpi_mysql_db }} -e "DELETE FROM glpi_authldaps WHERE name='{{ glpi_ldap_name }}';"
  changed_when: false
  failed_when: false

- name: Créer le script SQL temporaire pour la configuration LDAP
  ansible.builtin.copy:
    content: |
      INSERT INTO glpi_authldaps (
        name, host, port, basedn, rootdn, rootdn_passwd,
        login_field, sync_field, use_tls, is_active, is_default,
        `condition`, use_bind, date_creation, date_mod
      ) VALUES (
        '{{ glpi_ldap_name }}',
        '{{ glpi_ldap_host }}',
        {{ glpi_ldap_port }},
        '{{ glpi_ldap_basedn }}',
        '{{ glpi_ldap_rootdn }}',
        '{{ glpi_ldap_password }}',
        '{{ glpi_ldap_login_field }}',
        'objectguid',
        {{ '1' if glpi_ldap_use_tls else '0' }},
        1,
        1,
        '(objectClass=user)',
        1,
        NOW(),
        NOW()
      );
    dest: /tmp/glpi_ldap_config.sql
    mode: '0644'

- name: Copier le script SQL dans le conteneur
  ansible.builtin.command:
    cmd: docker cp /tmp/glpi_ldap_config.sql glpi_db:/tmp/glpi_ldap_config.sql

- name: Exécuter la configuration LDAP
  community.docker.docker_container_exec:
    container: glpi_db
    command: /bin/sh -c "mariadb -u {{ glpi_mysql_user }} -p{{ glpi_mysql_password }} {{ glpi_mysql_db }} < /tmp/glpi_ldap_config.sql"

- name: Nettoyer les fichiers temporaires
  ansible.builtin.file:
    path: /tmp/glpi_ldap_config.sql
    state: absent

- name: Afficher le statut de la configuration LDAP
  ansible.builtin.debug:
    msg:
      - "Configuration LDAP appliquée avec succès"
      - "Serveur: {{ glpi_ldap_host }}:{{ glpi_ldap_port }}"
      - "Base DN: {{ glpi_ldap_basedn }}"
      - "TLS: {{ 'Activé' if glpi_ldap_use_tls else 'Désactivé' }}"
